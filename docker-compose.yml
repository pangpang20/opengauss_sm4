services:
  opengauss_sm4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: opengauss_sm4
    hostname: opengauss_sm4
    privileged: true
    environment:
      - GS_PASSWORD=Enmo@123
      - GS_USERNAME=gaussdb
    ports:
      - "15432:5432"  # 映射到主机15432端口，避免与本地PostgreSQL冲突
    volumes:
      - ./test_sm4.sql:/opt/test_sm4.sql
      - ./test_sm4_gcm.sql:/opt/test_sm4_gcm.sql
      - ./demo_citizen_data.sql:/opt/demo_citizen_data.sql
      # 不挂载数据目录，让数据库在容器内部初始化
    networks:
      - opengauss_network
    healthcheck:
      test: ["CMD-SHELL", "gsql -d postgres -p 5432 -c 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped  # 自动重启

networks:
  opengauss_network:
    driver: bridge
